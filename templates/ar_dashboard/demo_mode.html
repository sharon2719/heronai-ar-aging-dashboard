{% extends 'base.html' %}

{% block title %}Demo Mode - Control Panel{% endblock %}
{% block breadcrumb %}Settings / Demo Mode{% endblock %}

{% block content %}
<style>
    .demo-panel {
        background: white;
        border: 2px solid #6366F1;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
    }

    .panel-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #E5E7EB;
    }

    .panel-header-icon {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #6366F1, #818CF8);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
    }

    .panel-header h2 {
        font-size: 18px;
        font-weight: 600;
        color: #111827;
    }

    .scenario-section {
        margin-bottom: 32px;
    }

    .scenario-section:last-child {
        margin-bottom: 0;
    }

    .scenario-title {
        font-size: 14px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6B7280;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .scenario-number {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        background: #6366F1;
        color: white;
        border-radius: 50%;
        font-size: 12px;
        font-weight: 700;
    }

    .demo-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
    }

    .demo-btn {
        padding: 12px 16px;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        white-space: nowrap;
    }

    .demo-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .demo-btn:active {
        transform: translateY(0);
    }

    .demo-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .demo-btn-primary {
        background: linear-gradient(135deg, #6366F1, #4F46E5);
        color: white;
    }

    .demo-btn-success {
        background: linear-gradient(135deg, #10B981, #059669);
        color: white;
    }

    .demo-btn-warning {
        background: linear-gradient(135deg, #F59E0B, #D97706);
        color: white;
    }

    .demo-btn-danger {
        background: linear-gradient(135deg, #EF4444, #DC2626);
        color: white;
    }

    .demo-btn-secondary {
        background: #F3F4F6;
        color: #111827;
        border: 1px solid #E5E7EB;
    }

    .demo-btn-secondary:hover {
        background: #E5E7EB;
    }

    .controls {
        display: flex;
        gap: 12px;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid #E5E7EB;
        flex-wrap: wrap;
    }

    .status-display {
        flex: 1;
        min-width: 300px;
        background: #F3F4F6;
        padding: 16px;
        border-radius: 8px;
        font-size: 13px;
        color: #6B7280;
    }

    .status-display.active {
        background: #DBEAFE;
        color: #0369A1;
    }

    .status-display.success {
        background: #D1FAE5;
        color: #065F46;
    }

    .status-icon {
        display: inline-block;
        margin-right: 6px;
    }

    .info-box {
        background: #EEF2FF;
        border: 1px solid #C7D2FE;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        font-size: 13px;
        color: #312E81;
        line-height: 1.6;
    }

    .info-box strong {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
    }

    .time-stamp {
        font-size: 12px;
        color: #9CA3AF;
        margin-top: 8px;
    }

    .metrics-preview {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(99, 102, 241, 0.02) 100%);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
    }

    .metric-item {
        text-align: center;
        padding: 12px;
        background: white;
        border-radius: 6px;
    }

    .metric-label {
        font-size: 11px;
        color: #6B7280;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .metric-value {
        font-size: 20px;
        font-weight: 700;
        color: #6366F1;
    }
</style>

<div class="page-header" style="margin-bottom: 32px;">
    <h1 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">
        Demo Mode Control Panel
    </h1>
    <p style="font-size: 14px; color: var(--text-secondary);">
        Simulate realistic business scenarios to showcase dashboard capabilities
    </p>
</div>

<div class="info-box">
    <strong>üìã How to use:</strong>
    Click the buttons below to simulate business events. Each action updates the dashboard metrics in real-time. 
    Open the <a href="{% url 'ar_dashboard:widget_dashboard' %}" target="_blank" style="color: #6366F1; font-weight: 600;">Interactive Dashboard</a> 
    in another tab to see changes live!
</div>

<!-- Current Metrics Preview -->
<div class="metrics-preview">
    <h3 style="font-size: 14px; font-weight: 600; color: #6B7280; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
        Current Metrics
    </h3>
    <div class="metrics-grid" id="metricsGrid">
        <div class="metric-item">
            <div class="metric-label">Total AR</div>
            <div class="metric-value" id="metric-total-ar">$2.5M</div>
        </div>
        <div class="metric-item">
            <div class="metric-label">Overdue %</div>
            <div class="metric-value" id="metric-overdue-pct">35%</div>
        </div>
        <div class="metric-item">
            <div class="metric-label">At Risk</div>
            <div class="metric-value" id="metric-at-risk">12</div>
        </div>
        <div class="metric-item">
            <div class="metric-label">DSO</div>
            <div class="metric-value" id="metric-dso">45</div>
        </div>
    </div>
</div>

<div class="demo-panel">
    <div class="panel-header">
        <div class="panel-header-icon">üìä</div>
        <h2>Demo Scenarios - A Day in Collections</h2>
    </div>

    <!-- Scenario 1: Morning -->
    <div class="scenario-section">
        <div class="scenario-title">
            <span class="scenario-number">1</span>
            Morning: New Business Arrives
        </div>
        <div class="demo-buttons">
            <button class="demo-btn demo-btn-primary" onclick="simulateNewInvoices(5)">
                <span>‚ûï</span> 5 New Invoices (+$150K)
            </button>
            <button class="demo-btn demo-btn-primary" onclick="simulateNewInvoices(10)">
                <span>‚ûï</span> 10 New Invoices (+$300K)
            </button>
            <button class="demo-btn demo-btn-primary" onclick="simulateNewInvoices(1)">
                <span>‚ûï</span> Single Invoice (+$30K)
            </button>
        </div>
    </div>

    <!-- Scenario 2: Mid-morning -->
    <div class="scenario-section">
        <div class="scenario-title">
            <span class="scenario-number">2</span>
            Mid-morning: Collections Activity
        </div>
        <div class="demo-buttons">
            <button class="demo-btn demo-btn-success" onclick="simulatePayments(1)">
                <span>‚úì</span> 1 Invoice Paid (-$40K)
            </button>
            <button class="demo-btn demo-btn-success" onclick="simulatePayments(3)">
                <span>‚úì</span> 3 Invoices Paid (-$120K)
            </button>
            <button class="demo-btn demo-btn-success" onclick="simulatePayments(5)">
                <span>‚úì</span> 5 Invoices Paid (-$200K)
            </button>
        </div>
    </div>

    <!-- Scenario 3: Afternoon -->
    <div class="scenario-section">
        <div class="scenario-title">
            <span class="scenario-number">3</span>
            Afternoon: Problem Emerges
        </div>
        <div class="demo-buttons">
            <button class="demo-btn demo-btn-warning" onclick="simulateAging()">
                <span>‚ö†Ô∏è</span> Invoice Ages (31‚Üí61 days)
            </button>
            <button class="demo-btn demo-btn-danger" onclick="simulateMajorOverdue()">
                <span>üö®</span> Major Customer Overdue
            </button>
            <button class="demo-btn demo-btn-danger" onclick="simulateHighRisk()">
                <span>‚ö†Ô∏è</span> High Risk Alert
            </button>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls">
        <div class="status-display" id="statusDisplay">
            <span class="status-icon">‚è±Ô∏è</span>
            <span id="statusText">Ready for demo. Click any button to begin.</span>
            <div class="time-stamp" id="timeStamp"></div>
        </div>
        <button class="demo-btn demo-btn-secondary" onclick="resetDemo()">
            <span>‚Ü∫</span> Reset Demo
        </button>
        <button class="demo-btn demo-btn-secondary" onclick="refreshMetrics()">
            <span>üîÑ</span> Refresh Metrics
        </button>
    </div>
</div>

<script>
    function updateStatus(message, type = 'active') {
        const statusDisplay = document.getElementById('statusDisplay');
        const statusText = document.getElementById('statusText');
        const timeStamp = document.getElementById('timeStamp');

        statusDisplay.classList.remove('active', 'success');
        statusDisplay.classList.add(type);
        statusText.textContent = message;
        timeStamp.textContent = new Date().toLocaleTimeString();
    }

    function updateMetricsDisplay(metrics) {
        document.getElementById('metric-total-ar').textContent = 
            '$' + (metrics.total_ar / 1000000).toFixed(1) + 'M';
        document.getElementById('metric-overdue-pct').textContent = 
            metrics.overdue_percentage.toFixed(0) + '%';
        document.getElementById('metric-at-risk').textContent = 
            metrics.at_risk_customers;
        document.getElementById('metric-dso').textContent = 
            metrics.dso || metrics.avg_days_overdue.toFixed(0);
    }

    function disableButtons(disabled) {
        document.querySelectorAll('.demo-btn').forEach(btn => {
            btn.disabled = disabled;
        });
    }

    async function simulateNewInvoices(count) {
        disableButtons(true);
        updateStatus(`Processing ${count} new invoice(s)...`, 'active');
        
        try {
            const response = await fetch('/ar/demo/new-invoices/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ count: count })
            });
            
            const data = await response.json();
            updateStatus(data.message, 'success');
            updateMetricsDisplay(data.metrics);
        } catch (error) {
            updateStatus('Error: ' + error.message, 'active');
        } finally {
            disableButtons(false);
        }
    }

    async function simulatePayments(count) {
        disableButtons(true);
        updateStatus(`Processing ${count} payment(s)...`, 'active');
        
        try {
            const response = await fetch('/ar/demo/invoice-paid/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ count: count })
            });
            
            const data = await response.json();
            updateStatus(data.message, 'success');
            updateMetricsDisplay(data.metrics);
        } catch (error) {
            updateStatus('Error: ' + error.message, 'active');
        } finally {
            disableButtons(false);
        }
    }

    async function simulateAging() {
        disableButtons(true);
        updateStatus('Aging invoices...', 'active');
        
        try {
            const response = await fetch('/ar/demo/invoice-aging/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            updateStatus(data.message, 'success');
            updateMetricsDisplay(data.metrics);
        } catch (error) {
            updateStatus('Error: ' + error.message, 'active');
        } finally {
            disableButtons(false);
        }
    }

    async function simulateMajorOverdue() {
        disableButtons(true);
        updateStatus('Simulating major overdue customer...', 'active');
        
        try {
            const response = await fetch('/ar/demo/major-overdue/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            updateStatus(data.message, 'success');
            updateMetricsDisplay(data.metrics);
        } catch (error) {
            updateStatus('Error: ' + error.message, 'active');
        } finally {
            disableButtons(false);
        }
    }

    async function simulateHighRisk() {
        disableButtons(true);
        updateStatus('Triggering high risk alert...', 'active');
        
        try {
            const response = await fetch('/ar/demo/high-risk-alert/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            updateStatus(data.message, 'success');
            updateMetricsDisplay(data.metrics);
        } catch (error) {
            updateStatus('Error: ' + error.message, 'active');
        } finally {
            disableButtons(false);
        }
    }

    async function resetDemo() {
        if (!confirm('Reset demo to baseline metrics?')) return;
        
        disableButtons(true);
        updateStatus('Resetting demo...', 'active');
        
        try {
            const response = await fetch('/ar/demo/reset/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            updateStatus(data.message, 'success');
            updateMetricsDisplay(data.metrics);
        } catch (error) {
            updateStatus('Error: ' + error.message, 'active');
        } finally {
            disableButtons(false);
        }
    }

    async function refreshMetrics() {
        try {
            const response = await fetch('/ar/demo/metrics/');
            const data = await response.json();
            updateMetricsDisplay(data.metrics);
            updateStatus('Metrics refreshed', 'success');
        } catch (error) {
            updateStatus('Error refreshing metrics', 'active');
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Load initial metrics on page load
    document.addEventListener('DOMContentLoaded', refreshMetrics);
</script>
{% endblock %}