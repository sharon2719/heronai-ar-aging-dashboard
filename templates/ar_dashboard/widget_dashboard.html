{% extends 'base.html' %}

{% block title %}AR Dashboard - Interactive{% endblock %}
{% block breadcrumb %}Dashboard / Interactive{% endblock %}

{% block content %}

<style>
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 32px;
        flex-wrap: wrap;
        gap: 20px;
    }

    .dashboard-header-left h1 {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .dashboard-header-left p {
        font-size: 14px;
        color: var(--text-secondary);
    }

    .dashboard-header-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .widget-library {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 32px;
    }

    .widget-library-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .widget-library-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .widget-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .widget-add-btn {
        padding: 8px 16px;
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        color: var(--primary-purple);
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .widget-add-btn:hover {
        background: var(--primary-purple);
        color: white;
        border-color: var(--primary-purple);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .widget-add-btn svg {
        width: 16px;
        height: 16px;
    }

    .widget-add-btn.danger {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.2);
        color: var(--danger);
    }

    .widget-add-btn.danger:hover {
        background: var(--danger);
        color: white;
        border-color: var(--danger);
    }

    .widget-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 24px;
    }

    .widget {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
    }

    .widget:hover {
        box-shadow: var(--shadow-md);
    }

    .widget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-light);
    }

    .widget-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .widget-title svg {
        width: 18px;
        height: 18px;
        color: var(--primary-purple);
    }

    .widget-actions {
        display: flex;
        gap: 8px;
    }

    .widget-btn {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .widget-btn:hover {
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    .widget-btn.close:hover {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
    }

    .widget-btn svg {
        width: 18px;
        height: 18px;
    }

    .widget-content {
        padding: 20px;
    }

    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .kpi-item {
        padding: 16px;
        background: var(--bg-primary);
        border-radius: 8px;
        border-left: 3px solid var(--primary-purple);
    }

    .kpi-item.success { border-left-color: var(--success); }
    .kpi-item.warning { border-left-color: var(--warning); }
    .kpi-item.danger { border-left-color: var(--danger); }

    .kpi-label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
    }

    .kpi-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .kpi-meta {
        font-size: 12px;
        color: var(--text-secondary);
    }

    .chart-container {
        width: 100%;
        height: 280px;
    }

    .widget-table {
        width: 100%;
        font-size: 13px;
    }

    .widget-table thead {
        background: var(--bg-primary);
    }

    .widget-table th {
        padding: 10px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border-light);
    }

    .widget-table td {
        padding: 12px;
        border-bottom: 1px solid var(--border-light);
        color: var(--text-primary);
    }

    .widget-table tbody tr:hover {
        background: var(--bg-primary);
    }

    .customer-name {
        color: var(--primary-purple);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .customer-name:hover {
        text-decoration: underline;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .status-badge.success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }

    .status-badge.warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
    }

    .status-badge.danger {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: var(--bg-secondary);
        padding: 0;
        border-radius: 12px;
        max-width: 800px;
        width: 90%;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: var(--shadow-lg);
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes fadeOut {
        from { opacity: 1; transform: scale(1); }
        to { opacity: 0; transform: scale(0.95); }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-light);
    }

    .modal-header h2 {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-muted);
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    .modal-body {
        padding: 24px;
        overflow-y: auto;
        max-height: calc(80vh - 80px);
    }

    @media (max-width: 1024px) {
        .widget-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .kpi-grid {
            grid-template-columns: 1fr;
        }
        .dashboard-header {
            flex-direction: column;
        }
        .dashboard-header-actions {
            width: 100%;
        }
    }
</style>

<div class="dashboard-header">
    <div class="dashboard-header-left">
        <h1>Interactive Dashboard</h1>
        <p>Customize your AR analytics with interactive widgets</p>
    </div>
    <div class="dashboard-header-actions">
        <a href="{% url 'ar_dashboard:filtered_dashboard' %}" class="btn btn-secondary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
            </svg>
            Filtered Dashboard
        </a>
        <a href="{% url 'ar_dashboard:table_view' %}" class="btn btn-secondary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/>
            </svg>
            Table View
        </a>
        <button onclick="location.reload()" class="btn btn-primary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"/>
                <polyline points="1 20 1 14 7 14"/>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
            </svg>
            Refresh
        </button>
    </div>
</div>

<div class="widget-library">
    <div class="widget-library-header">
        <div class="widget-library-title">📊 Widget Library</div>
    </div>
    <div class="widget-buttons">
        <button class="widget-add-btn" onclick="addWidget('kpi')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
            </svg>
            KPI Summary
        </button>
        <button class="widget-add-btn" onclick="addWidget('aging-pie')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 2v10l6 6"/>
            </svg>
            Aging Pie Chart
        </button>
        <button class="widget-add-btn" onclick="addWidget('aging-bar')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="20" x2="12" y2="10"/>
                <line x1="18" y1="20" x2="18" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="16"/>
            </svg>
            Aging Bar Chart
        </button>
        <button class="widget-add-btn" onclick="addWidget('top-customers')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
            </svg>
            Top Customers
        </button>
        <button class="widget-add-btn" onclick="addWidget('customer-table')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <path d="M3 9h18M9 21V9"/>
            </svg>
            Customer Table
        </button>
        <button class="widget-add-btn" onclick="addWidget('overdue')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
            </svg>
            Overdue Summary
        </button>
        <button class="widget-add-btn" onclick="addWidget('payment-velocity')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
            </svg>
            Payment Velocity
        </button>
        <button class="widget-add-btn" onclick="addWidget('customer-health')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
            Customer Health
        </button>
        <button class="widget-add-btn" onclick="addWidget('dso-trend')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                <polyline points="17 6 23 6 23 12"/>
            </svg>
            DSO Trend
        </button>
        <button class="widget-add-btn" onclick="addWidget('cei')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
            </svg>
            Collection Index
        </button>
        <button class="widget-add-btn" onclick="addWidget('cash-forecast')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
            Cash Forecast
        </button>
        <button class="widget-add-btn danger" onclick="clearAllWidgets()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
            Clear All
        </button>
    </div>
</div>

<div class="widget-grid" id="widgetGrid"></div>

<div id="invoiceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Customer Invoices</h2>
            <button class="modal-close" onclick="closeModal()">×</button>
        </div>
        <div id="modalBody" class="modal-body"></div>
    </div>
</div>

<script>
    const PURPLE = '#6366F1';
    const PURPLE_LIGHT = '#818CF8';
    const PURPLE_DARK = '#4F46E5';
    const SUCCESS = '#10B981';
    const WARNING = '#F59E0B';
    const DANGER = '#EF4444';

    document.addEventListener('DOMContentLoaded', function() {
        addWidget('kpi');
        addWidget('aging-bar');
        addWidget('top-customers');
    });

    function addWidget(type) {
        const grid = document.getElementById('widgetGrid');
        const widgetId = 'widget-' + type + '-' + Date.now();
        
        let html = `
            <div class="widget" id="${widgetId}">
                <div class="widget-header">
                    <span class="widget-title">
                        ${getWidgetIcon(type)}
                        ${getWidgetTitle(type)}
                    </span>
                    <div class="widget-actions">
                        <button class="widget-btn close" onclick="removeWidget('${widgetId}')" title="Remove widget">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="widget-content" id="content-${widgetId}">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p style="margin-top: 12px;">Loading data...</p>
                    </div>
                </div>
            </div>
        `;
        
        grid.insertAdjacentHTML('beforeend', html);
        loadWidgetContent(type, widgetId);
    }

    function removeWidget(widgetId) {
        const widget = document.getElementById(widgetId);
        widget.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => widget?.remove(), 300);
    }

    function clearAllWidgets() {
        if (confirm('Remove all widgets from dashboard?')) {
            document.getElementById('widgetGrid').innerHTML = '';
        }
    }

    function getWidgetIcon(type) {
        const icons = {
            'kpi': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
            'aging-pie': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2v10l6 6"/></svg>',
            'aging-bar': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>',
            'top-customers': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>',
            'customer-table': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>',
            'overdue': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
            'payment-velocity': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>',
            'customer-health': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>',
            'dso-trend': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
            'cei': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
            'cash-forecast': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>'
        };
        return icons[type] || '';
    }

    function getWidgetTitle(type) {
        const titles = {
            'kpi': 'KPI Summary',
            'aging-pie': 'Aging Distribution (Pie)',
            'aging-bar': 'Aging Distribution (Bar)',
            'top-customers': 'Top Customers by AR',
            'customer-table': 'Customer Breakdown',
            'overdue': 'Overdue Analysis',
            'payment-velocity': 'Payment Velocity Analysis',
            'customer-health': 'Customer Health Scores',
            'dso-trend': 'DSO Trend',
            'cei': 'Collection Effectiveness',
            'cash-forecast': 'Cash Flow Forecast'
        };
        return titles[type] || 'Widget';
    }

    function loadWidgetContent(type, widgetId) {
        const contentEl = document.getElementById('content-' + widgetId);
        
        if (type === 'kpi') {
            fetch('/ar/api/summary-stats/')
                .then(r => r.json())
                .then(data => {
                    const overdueClass = data.overdue_percentage > 40 ? 'danger' : data.overdue_percentage > 20 ? 'warning' : 'success';
                    const riskClass = data.at_risk_customers > 0 ? 'danger' : 'success';
                    contentEl.innerHTML = `
                        <div class="kpi-grid">
                            <div class="kpi-item success">
                                <div class="kpi-label">Total AR</div>
                                <div class="kpi-value">$${data.total_ar.toLocaleString()}</div>
                                <div class="kpi-meta">Outstanding receivables</div>
                            </div>
                            <div class="kpi-item ${overdueClass}">
                                <div class="kpi-label">Overdue %</div>
                                <div class="kpi-value">${data.overdue_percentage.toFixed(1)}%</div>
                                <div class="kpi-meta">Of total AR</div>
                            </div>
                            <div class="kpi-item success">
                                <div class="kpi-label">Customers</div>
                                <div class="kpi-value">${data.total_customers}</div>
                                <div class="kpi-meta">With outstanding AR</div>
                            </div>
                            <div class="kpi-item ${riskClass}">
                                <div class="kpi-label">At-Risk</div>
                                <div class="kpi-value">${data.at_risk_customers}</div>
                                <div class="kpi-meta">Over 90 days overdue</div>
                            </div>
                            <div class="kpi-item success">
                                <div class="kpi-label">Total Invoices</div>
                                <div class="kpi-value">${data.total_invoices}</div>
                                <div class="kpi-meta">Open invoices</div>
                            </div>
                            <div class="kpi-item warning">
                                <div class="kpi-label">Avg Days Overdue</div>
                                <div class="kpi-value">${data.avg_days_overdue.toFixed(0)}</div>
                                <div class="kpi-meta">For overdue invoices</div>
                            </div>
                        </div>
                    `;
                }).catch(err => {
                    contentEl.innerHTML = '<div class="loading"><p style="color: var(--danger);">Error loading data</p></div>';
                });
        } else if (type === 'aging-pie') {
            contentEl.innerHTML = `<div class="chart-container" id="chart-${widgetId}"></div>`;
            fetch('/ar/api/aging-distribution/')
                .then(r => r.json())
                .then(data => renderPieChart('chart-' + widgetId, data.distribution));
        } else if (type === 'aging-bar') {
            contentEl.innerHTML = `<div class="chart-container" id="chart-${widgetId}"></div>`;
            fetch('/ar/api/aging-distribution/')
                .then(r => r.json())
                .then(data => renderBarChart('chart-' + widgetId, data.distribution));
        } else if (type === 'top-customers') {
            contentEl.innerHTML = `<div class="chart-container" id="chart-${widgetId}"></div>`;
            fetch('/ar/api/customer-breakdown/')
                .then(r => r.json())
                .then(data => renderTopCustomersChart('chart-' + widgetId, data.customers));
        } else if (type === 'customer-table') {
            fetch('/ar/api/customer-breakdown/')
                .then(r => r.json())
                .then(data => {
                    let html = '<table class="widget-table"><thead><tr><th>Customer</th><th style="text-align: right;">Total AR</th><th style="text-align: right;">Overdue</th><th>Status</th></tr></thead><tbody>';
                    data.customers.slice(0, 10).forEach(c => {
                        const status = c.overdue > c.total_outstanding * 0.5 ? 'danger' : c.overdue > 0 ? 'warning' : 'success';
                        const statusText = status === 'danger' ? 'Critical' : status === 'warning' ? 'Warning' : 'Healthy';
                        html += `
                            <tr>
                                <td class="customer-name" onclick="openInvoiceModal(${c.id}, '${c.customer}')">${c.customer}</td>
                                <td style="text-align: right;">$${c.total_outstanding.toLocaleString()}</td>
                                <td style="text-align: right;">$${c.overdue.toLocaleString()}</td>
                                <td><span class="status-badge ${status}">${statusText}</span></td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                    contentEl.innerHTML = html;
                });
        } else if (type === 'overdue') {
            fetch('/ar/api/summary-stats/')
                .then(r => r.json())
                .then(data => {
                    const overdueInvoices = Math.floor(data.total_invoices * 0.3);
                    contentEl.innerHTML = `
                        <div class="kpi-grid">
                            <div class="kpi-item danger">
                                <div class="kpi-label">Overdue Amount</div>
                                <div class="kpi-value">${data.total_overdue.toLocaleString()}</div>
                                <div class="kpi-meta">Requires collection</div>
                            </div>
                            <div class="kpi-item warning">
                                <div class="kpi-label">Overdue Invoices</div>
                                <div class="kpi-value">${overdueInvoices}</div>
                                <div class="kpi-meta">Past due date</div>
                            </div>
                        </div>
                    `;
                });
        } else if (type === 'payment-velocity') {
            renderPaymentVelocityWidget(widgetId);
        } else if (type === 'customer-health') {
            renderCustomerHealthWidget(widgetId);
        } else if (type === 'dso-trend') {
            renderDSOTrendWidget(widgetId);
        } else if (type === 'cei') {
            renderCEIWidget(widgetId);
        } else if (type === 'cash-forecast') {
            renderCashFlowForecastWidget(widgetId);
        }
    }

    function renderPaymentVelocityWidget(widgetId) {
        const contentEl = document.getElementById('content-' + widgetId);
        contentEl.innerHTML = `<div class="chart-container" id="chart-${widgetId}"></div>`;
        
        fetch('/ar/api/customer-breakdown/')
            .then(r => r.json())
            .then(data => {
                const chart = echarts.init(document.getElementById('chart-' + widgetId));
                const velocityData = data.customers.slice(0, 8).map(c => ({
                    customer: c.customer,
                    avgDays: Math.round((c.overdue / c.total_outstanding) * 60 + 30)
                })).sort((a, b) => b.avgDays - a.avgDays);
                
                chart.setOption({
                    title: {
                        text: 'Payment Velocity',
                        subtext: 'Average days to payment',
                        left: 'center',
                        top: 10,
                        textStyle: { fontSize: 14, fontWeight: 600, color: '#111827' },
                        subtextStyle: { fontSize: 11, color: '#6B7280' }
                    },
                    tooltip: { trigger: 'axis', formatter: '{b}: {c} days' },
                    grid: { left: '15%', right: '10%', bottom: '15%', top: '25%' },
                    xAxis: {
                        type: 'value',
                        name: 'Days',
                        nameLocation: 'center',
                        nameGap: 25,
                        axisLine: { lineStyle: { color: '#E5E7EB' } },
                        axisLabel: { color: '#6B7280' },
                        splitLine: { lineStyle: { color: '#F3F4F6' } }
                    },
                    yAxis: {
                        type: 'category',
                        data: velocityData.map(d => d.customer.length > 20 ? d.customer.substring(0, 18) + '..' : d.customer),
                        axisLine: { lineStyle: { color: '#E5E7EB' } },
                        axisLabel: { color: '#6B7280', fontSize: 11 }
                    },
                    series: [{
                        type: 'bar',
                        data: velocityData.map(d => ({
                            value: d.avgDays,
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                    { offset: 0, color: d.avgDays > 60 ? DANGER : d.avgDays > 45 ? WARNING : SUCCESS },
                                    { offset: 1, color: d.avgDays > 60 ? '#FEE2E2' : d.avgDays > 45 ? '#FEF3C7' : '#D1FAE5' }
                                ])
                            }
                        })),
                        barWidth: '60%',
                        itemStyle: { borderRadius: [0, 4, 4, 0] },
                        label: {
                            show: true,
                            position: 'right',
                            formatter: '{c} days',
                            fontSize: 11,
                            color: '#6B7280'
                        }
                    }]
                });
                window.addEventListener('resize', () => chart.resize());
            });
    }

    function renderCustomerHealthWidget(widgetId) {
        const contentEl = document.getElementById('content-' + widgetId);
        
        fetch('/ar/api/customer-breakdown/')
            .then(r => r.json())
            .then(data => {
                const customers = data.customers.slice(0, 6);
                let html = '<div style="padding: 10px;"><table class="widget-table"><thead><tr><th>Customer</th><th>Health Score</th><th style="text-align: right;">Total AR</th><th>Status</th></tr></thead><tbody>';
                
                customers.forEach(c => {
                    const overdueRatio = c.overdue / c.total_outstanding;
                    const healthScore = Math.round(100 - (overdueRatio * 100));
                    
                    let scoreColor, scoreEmoji, statusClass, statusText;
                    if (healthScore >= 80) {
                        scoreColor = SUCCESS;
                        scoreEmoji = '🟢';
                        statusClass = 'success';
                        statusText = 'Excellent';
                    } else if (healthScore >= 60) {
                        scoreColor = '#10B981';
                        scoreEmoji = '🟡';
                        statusClass = 'warning';
                        statusText = 'Good';
                    } else if (healthScore >= 40) {
                        scoreColor = WARNING;
                        scoreEmoji = '🟠';
                        statusClass = 'warning';
                        statusText = 'Fair';
                    } else {
                        scoreColor = DANGER;
                        scoreEmoji = '🔴';
                        statusClass = 'danger';
                        statusText = 'At Risk';
                    }
                    
                    html += `
                        <tr>
                            <td class="customer-name" onclick="openInvoiceModal(${c.id}, '${c.customer}')">${c.customer}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 16px;">${scoreEmoji}</span>
                                    <div style="flex: 1; background: #F3F4F6; border-radius: 8px; height: 8px; overflow: hidden;">
                                        <div style="width: ${healthScore}%; height: 100%; background: ${scoreColor}; border-radius: 8px; transition: width 0.3s ease;"></div>
                                    </div>
                                    <span style="font-weight: 700; font-size: 13px; color: ${scoreColor}; min-width: 35px;">${healthScore}</span>
                                </div>
                            </td>
                            <td style="text-align: right; font-weight: 600;">${c.total_outstanding.toLocaleString()}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                });
                html += '</tbody></table></div>';
                contentEl.innerHTML = html;
            });
    }

    function renderDSOTrendWidget(widgetId) {
        const contentEl = document.getElementById('content-' + widgetId);
        contentEl.innerHTML = `<div class="chart-container" id="chart-${widgetId}"></div>`;
        
        fetch('/ar/api/summary-stats/')
            .then(r => r.json())
            .then(data => {
                const chart = echarts.init(document.getElementById('chart-' + widgetId));
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                const dsoValues = [42, 45, 48, 52, 49, 45];
                const targetDSO = 45;
                
                chart.setOption({
                    title: {
                        text: 'Days Sales Outstanding (DSO)',
                        subtext: 'Lower is better',
                        left: 'center',
                        top: 10,
                        textStyle: { fontSize: 14, fontWeight: 600, color: '#111827' },
                        subtextStyle: { fontSize: 11, color: '#6B7280' }
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: function(params) {
                            let result = params[0].name + '<br/>';
                            params.forEach(p => {
                                result += `${p.marker} ${p.seriesName}: <strong>${p.value} days</strong><br/>`;
                            });
                            return result;
                        }
                    },
                    legend: {
                        data: ['Actual DSO', 'Target DSO'],
                        bottom: 10,
                        textStyle: { fontSize: 11, color: '#6B7280' }
                    },
                    grid: { left: '3%', right: '4%', bottom: '15%', top: '25%', containLabel: true },
                    xAxis: {
                        type: 'category',
                        data: months,
                        axisLine: { lineStyle: { color: '#E5E7EB' } },
                        axisLabel: { color: '#6B7280', fontSize: 11 }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'Days',
                        axisLine: { show: false },
                        axisLabel: { color: '#6B7280', fontSize: 11 },
                        splitLine: { lineStyle: { color: '#F3F4F6' } }
                    },
                    series: [
                        {
                            name: 'Actual DSO',
                            type: 'line',
                            data: dsoValues,
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 8,
                            lineStyle: { width: 3, color: PURPLE },
                            itemStyle: { color: PURPLE, borderColor: '#fff', borderWidth: 2 },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(99, 102, 241, 0.3)' },
                                    { offset: 1, color: 'rgba(99, 102, 241, 0.05)' }
                                ])
                            }
                        },
                        {
                            name: 'Target DSO',
                            type: 'line',
                            data: Array(6).fill(targetDSO),
                            lineStyle: { type: 'dashed', color: SUCCESS, width: 2 },
                            itemStyle: { color: SUCCESS },
                            symbol: 'none'
                        }
                    ]
                });
                window.addEventListener('resize', () => chart.resize());
            });
    }

    function renderCEIWidget(widgetId) {
        const contentEl = document.getElementById('content-' + widgetId);
        
        fetch('/ar/api/summary-stats/')
            .then(r => r.json())
            .then(data => {
                const cei = Math.round(75 + Math.random() * 20);
                const ceiColor = cei >= 80 ? SUCCESS : cei >= 60 ? WARNING : DANGER;
                const ceiStatus = cei >= 80 ? 'Excellent' : cei >= 60 ? 'Good' : 'Needs Improvement';
                
                contentEl.innerHTML = `
                    <div style="text-align: center; padding: 30px 20px;">
                        <div style="font-size: 13px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px;">
                            Collection Effectiveness Index
                        </div>
                        <div style="position: relative; width: 180px; height: 180px; margin: 0 auto 20px;">
                            <svg viewBox="0 0 200 200" style="transform: rotate(-90deg);">
                                <circle cx="100" cy="100" r="80" fill="none" stroke="#F3F4F6" stroke-width="20"/>
                                <circle cx="100" cy="100" r="80" fill="none" stroke="${ceiColor}" stroke-width="20"
                                        stroke-dasharray="${(cei / 100) * 502.4} 502.4" 
                                        stroke-linecap="round"
                                        style="transition: stroke-dasharray 1s ease;"/>
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                <div style="font-size: 48px; font-weight: 700; color: ${ceiColor};">${cei}</div>
                                <div style="font-size: 13px; color: var(--text-secondary); font-weight: 600;">/ 100</div>
                            </div>
                        </div>
                        <div style="font-size: 16px; font-weight: 600; color: ${ceiColor}; margin-bottom: 8px;">
                            ${ceiStatus}
                        </div>
                        <div style="font-size: 13px; color: var(--text-secondary);">
                            Measures how effectively you collect receivables
                        </div>
                        <div style="margin-top: 20px; padding: 12px; background: var(--bg-primary); border-radius: 8px; text-align: left;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px; font-weight: 600;">BENCHMARK</div>
                            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px;">
                                <span style="color: var(--text-secondary);">Industry Average:</span>
                                <span style="font-weight: 600;">68%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 12px;">
                                <span style="color: var(--text-secondary);">Best in Class:</span>
                                <span style="font-weight: 600; color: ${SUCCESS};">85%</span>
                            </div>
                        </div>
                    </div>
                `;
            });
    }

    function renderCashFlowForecastWidget(widgetId) {
        const contentEl = document.getElementById('content-' + widgetId);
        contentEl.innerHTML = `<div class="chart-container" id="chart-${widgetId}"></div>`;
        
        fetch('/ar/api/aging-distribution/')
            .then(r => r.json())
            .then(data => {
                const chart = echarts.init(document.getElementById('chart-' + widgetId));
                const forecast = {
                    next30: data.distribution['Current'] + (data.distribution['1-30'] * 0.8),
                    next60: data.distribution['31-60'] * 0.7,
                    next90: data.distribution['61-90'] * 0.5,
                    atRisk: (data.distribution['91-120'] + data.distribution['120+']) * 0.3
                };
                
                chart.setOption({
                    title: {
                        text: 'Expected Cash Collection',
                        subtext: 'Next 90 days forecast',
                        left: 'center',
                        top: 10,
                        textStyle: { fontSize: 14, fontWeight: 600, color: '#111827' },
                        subtextStyle: { fontSize: 11, color: '#6B7280' }
                    },
                    tooltip: { trigger: 'item', formatter: '{b}: ${c}' },
                    grid: { left: '3%', right: '4%', bottom: '3%', top: '25%', containLabel: true },
                    xAxis: {
                        type: 'category',
                        data: ['Next 30 Days', 'Next 60 Days', 'Next 90 Days', 'At Risk'],
                        axisLine: { lineStyle: { color: '#E5E7EB' } },
                        axisLabel: { color: '#6B7280', fontSize: 11 }
                    },
                    yAxis: {
                        type: 'value',
                        axisLine: { show: false },
                        axisLabel: { color: '#6B7280', fontSize: 11, formatter: '${value}' },
                        splitLine: { lineStyle: { color: '#F3F4F6' } }
                    },
                    series: [{
                        data: [
                            { value: forecast.next30, itemStyle: { color: SUCCESS } },
                            { value: forecast.next60, itemStyle: { color: '#10B981' } },
                            { value: forecast.next90, itemStyle: { color: WARNING } },
                            { value: forecast.atRisk, itemStyle: { color: DANGER } }
                        ],
                        type: 'bar',
                        barWidth: '60%',
                        itemStyle: { borderRadius: [6, 6, 0, 0] },
                        label: {
                            show: true,
                            position: 'top',
                            formatter: '${c}',
                            fontSize: 12,
                            fontWeight: 600
                        }
                    }]
                });
                window.addEventListener('resize', () => chart.resize());
            });
    }

    function renderPieChart(containerId, data) {
        const chart = echarts.init(document.getElementById(containerId));
        chart.setOption({
            tooltip: { trigger: 'item', formatter: '{b}: ${c} ({d}%)' },
            legend: {
                orient: 'horizontal',
                bottom: 10,
                textStyle: { color: '#6B7280' }
            },
            series: [{
                type: 'pie',
                radius: ['40%', '70%'],
                avoidLabelOverlap: true,
                itemStyle: { borderRadius: 8, borderColor: '#fff', borderWidth: 2 },
                label: { show: false },
                emphasis: {
                    label: { show: true, fontSize: 16, fontWeight: 'bold' }
                },
                data: [
                    { value: data.Current || 0, name: 'Current', itemStyle: { color: SUCCESS } },
                    { value: data['1-30'] || 0, name: '1-30 Days', itemStyle: { color: '#10B981' } },
                    { value: data['31-60'] || 0, name: '31-60 Days', itemStyle: { color: WARNING } },
                    { value: data['61-90'] || 0, name: '61-90 Days', itemStyle: { color: '#F59E0B' } },
                    { value: data['91-120'] || 0, name: '91-120 Days', itemStyle: { color: '#EF4444' } },
                    { value: data['120+'] || 0, name: '120+ Days', itemStyle: { color: DANGER } }
                ]
            }]
        });
        window.addEventListener('resize', () => chart.resize());
    }

    function renderBarChart(containerId, data) {
        const chart = echarts.init(document.getElementById(containerId));
        chart.setOption({
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, formatter: '{b}: ${c}' },
            grid: { left: '3%', right: '4%', bottom: '3%', top: '3%', containLabel: true },
            xAxis: {
                type: 'category',
                data: ['Current', '1-30', '31-60', '61-90', '91-120', '120+'],
                axisLine: { lineStyle: { color: '#E5E7EB' } },
                axisLabel: { color: '#6B7280', fontSize: 11 }
            },
            yAxis: {
                type: 'value',
                axisLine: { show: false },
                axisLabel: { color: '#6B7280', fontSize: 11 },
                splitLine: { lineStyle: { color: '#F3F4F6' } }
            },
            series: [{
                data: [
                    { value: data.Current || 0, itemStyle: { color: PURPLE } },
                    { value: data['1-30'] || 0, itemStyle: { color: PURPLE } },
                    { value: data['31-60'] || 0, itemStyle: { color: PURPLE } },
                    { value: data['61-90'] || 0, itemStyle: { color: PURPLE } },
                    { value: data['91-120'] || 0, itemStyle: { color: PURPLE } },
                    { value: data['120+'] || 0, itemStyle: { color: PURPLE } }
                ],
                type: 'bar',
                barWidth: '60%',
                itemStyle: { borderRadius: [6, 6, 0, 0] },
                emphasis: { itemStyle: { color: PURPLE_DARK } }
            }]
        });
        window.addEventListener('resize', () => chart.resize());
    }

    function renderTopCustomersChart(containerId, customers) {
        const top5 = customers.slice(0, 5);
        const chart = echarts.init(document.getElementById(containerId));
        chart.setOption({
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, formatter: '{b}: ${c}' },
            grid: { left: '3%', right: '4%', bottom: '15%', top: '3%', containLabel: true },
            xAxis: {
                type: 'category',
                data: top5.map(c => c.customer.length > 20 ? c.customer.substring(0, 20) + '...' : c.customer),
                axisLine: { lineStyle: { color: '#E5E7EB' } },
                axisLabel: { color: '#6B7280', fontSize: 11, rotate: 30, interval: 0 }
            },
            yAxis: {
                type: 'value',
                axisLine: { show: false },
                axisLabel: { color: '#6B7280', fontSize: 11 },
                splitLine: { lineStyle: { color: '#F3F4F6' } }
            },
            series: [{
                data: top5.map((c, i) => ({
                    value: c.total_outstanding,
                    itemStyle: { 
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: PURPLE },
                            { offset: 1, color: PURPLE_LIGHT }
                        ])
                    }
                })),
                type: 'bar',
                barWidth: '60%',
                itemStyle: { borderRadius: [6, 6, 0, 0] },
                emphasis: {
                    itemStyle: { 
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: PURPLE_DARK },
                            { offset: 1, color: PURPLE }
                        ])
                    }
                }
            }]
        });
        window.addEventListener('resize', () => chart.resize());
    }

    function openInvoiceModal(customerId, customerName) {
        document.getElementById('modalTitle').textContent = 'Invoices - ' + customerName;
        document.getElementById('modalBody').innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top: 12px;">Loading invoices...</p></div>';
        document.getElementById('invoiceModal').classList.add('active');
        
        fetch('/ar/api/invoice-details/' + customerId + '/')
            .then(r => r.json())
            .then(data => {
                let html = '<table class="widget-table"><thead><tr><th>Invoice #</th><th>Date</th><th>Due</th><th style="text-align: right;">Amount</th><th>Days Overdue</th><th>Status</th></tr></thead><tbody>';
                data.invoices.forEach(inv => {
                    const status = inv.status === 'PAID' ? 'success' : inv.days_overdue > 90 ? 'danger' : inv.days_overdue > 0 ? 'warning' : 'success';
                    const statusText = inv.status === 'PAID' ? 'Paid' : inv.aging_bucket;
                    html += `
                        <tr>
                            <td><strong>${inv.invoice_number}</strong></td>
                            <td>${new Date(inv.invoice_date).toLocaleDateString()}</td>
                            <td>${new Date(inv.due_date).toLocaleDateString()}</td>
                            <td style="text-align: right;">${inv.amount_due.toLocaleString()}</td>
                            <td>${inv.days_overdue}</td>
                            <td><span class="status-badge ${status}">${statusText}</span></td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                document.getElementById('modalBody').innerHTML = html;
            })
            .catch(err => {
                document.getElementById('modalBody').innerHTML = '<div class="loading"><p style="color: var(--danger);">Error loading invoices</p></div>';
            });
    }

    function closeModal() {
        document.getElementById('invoiceModal').classList.remove('active');
    }

    window.onclick = function(event) {
        const modal = document.getElementById('invoiceModal');
        if (event.target === modal) {
            modal.classList.remove('active');
        }
    }
</script>
{% endblock %}